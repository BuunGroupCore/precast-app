#!/bin/sh

# Run linting and type checking for all packages
echo "üîç Running pre-commit checks..."

# Auto-fix prettier formatting
echo "üìù Auto-formatting code with Prettier..."
bunx prettier --write "packages/**/*.{ts,tsx,js,jsx,json,md,css,scss}"

# Add the formatted files back to the commit
git add -A

# Double-check formatting is correct
echo "‚úîÔ∏è  Verifying code formatting..."
bunx prettier --check "packages/**/*.{ts,tsx,js,jsx,json,md,css,scss}" || {
  echo "‚ùå Prettier formatting issues found after auto-fix. Please check manually."
  exit 1
}

# Run ESLint for website
echo "üîç Running ESLint..."
cd packages/website && bunx eslint src --ext .ts,.tsx --max-warnings 0 || {
  echo "‚ùå ESLint errors found in website package."
  exit 1
}
cd ../..

# Run TypeScript type checking for CLI
echo "üì¶ Type checking CLI package..."
cd packages/cli && bunx tsc --noEmit || {
  echo "‚ùå TypeScript errors found in CLI package."
  exit 1
}
cd ../..

# Run TypeScript type checking for website
echo "üåê Type checking website package..."
cd packages/website && bunx tsc --noEmit || {
  echo "‚ùå TypeScript errors found in website package."
  exit 1
}
cd ../..

# Run tests if they exist
# echo "üß™ Running tests..."
# cd packages/cli && bun test --run 2>/dev/null || {
#   echo "‚ö†Ô∏è  CLI tests failed or not found."
# }
# cd ../..

echo "‚úÖ All pre-commit checks passed!"
