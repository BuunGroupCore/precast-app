#!/bin/bash

# Precast Development Setup Script
# Automatically sets up the development environment including Docker services
# Generated: {{timestamp}}

set -e

# Colors for output
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
NC='\033[0m' # No Color

# Icons
SETUP_ICON="🚀"
DOCKER_ICON="🐳"
SUCCESS_ICON="✅"
INFO_ICON="ℹ️"

log_info() {
    echo -e "${BLUE}${INFO_ICON} $1${NC}"
}

log_success() {
    echo -e "${GREEN}${SUCCESS_ICON} $1${NC}"
}

log_setup() {
    echo -e "${YELLOW}${SETUP_ICON} $1${NC}"
}

log_docker() {
    echo -e "${BLUE}${DOCKER_ICON} $1${NC}"
}

echo
log_setup "Precast Development Environment Setup"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"

# Install dependencies
log_info "Installing dependencies..."
{{#if usesBun}}
if command -v bun >/dev/null 2>&1; then
    bun install
else
    log_info "Bun not found, falling back to npm"
    npm install
fi
{{else if usesPnpm}}
if command -v pnpm >/dev/null 2>&1; then
    pnpm install
else
    log_info "pnpm not found, falling back to npm"
    npm install
fi
{{else if usesYarn}}
if command -v yarn >/dev/null 2>&1; then
    yarn install
else
    log_info "Yarn not found, falling back to npm"
    npm install
fi
{{else}}
npm install
{{/if}}

log_success "Dependencies installed"

{{#if hasDocker}}
# Setup Docker services
log_docker "Setting up Docker services..."

if command -v docker >/dev/null 2>&1; then
    if docker info >/dev/null 2>&1; then
        # Docker is running, start auto-deploy
        if [[ -f "scripts/docker-auto-deploy.sh" ]]; then
            log_docker "Starting Docker services..."
            ./scripts/docker-auto-deploy.sh
        else
            log_info "Docker auto-deploy script not found, skipping Docker setup"
        fi
    else
        log_info "Docker is installed but not running. Please start Docker and run:"
        echo "  npm run docker:deploy"
    fi
else
    log_info "Docker not found. To use Docker services, please:"
    echo "  1. Install Docker"
    echo "  2. Start Docker"
    echo "  3. Run: npm run docker:deploy"
fi
{{else}}
log_info "Docker not configured for this project"
{{/if}}

echo
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
log_success "Development environment setup complete!"

echo
log_info "Next steps:"
{{#if hasDocker}}
echo "  npm run dev        - Start development servers"
echo "  npm run dev:docker - Start Docker + development servers"
echo "  npm run docker:status - Check Docker service status"
{{else}}
echo "  npm run dev  - Start development servers"
echo "  npm run build - Build for production"
{{/if}}

{{#if database}}
{{#unless (eq database "none")}}
echo
log_info "Database commands:"
echo "  npm run {{database}}:logs  - View database logs"
echo "  npm run {{database}}:down - Stop database"
{{/unless}}
{{/if}}

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
