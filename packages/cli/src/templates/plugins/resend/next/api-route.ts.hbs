/**
 * Email API Route
 * @module email-api
 * @description Next.js API route for sending emails via Resend
 */

import { NextRequest, NextResponse } from 'next/server';

import { sendEmail } from '@/services/email';

/**
 * Handles POST requests for sending emails
 * @param {NextRequest} request - The incoming request
 * @returns {Promise<NextResponse>} JSON response with success/error status
 */
export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    const { to, subject, html, text, type } = body;

    if (!to || !subject) {
      return NextResponse.json(
        { error: 'Missing required fields: to, subject' },
        { status: 400 }
      );
    }

    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    const emails = Array.isArray(to) ? to : [to];
    const invalidEmails = emails.filter((email: string) => !emailRegex.test(email));
    
    if (invalidEmails.length > 0) {
      return NextResponse.json(
        { error: `Invalid email addresses: ${invalidEmails.join(', ')}` },
        { status: 400 }
      );
    }

    let result;
    switch (type) {
      case 'welcome': {
        const { name } = body;
        if (!name) {
          return NextResponse.json(
            { error: 'Name is required for welcome emails' },
            { status: 400 }
          );
        }
        const { sendWelcomeEmail } = await import('@/services/email');
        result = await sendWelcomeEmail(to, name);
        break;
      }

      case 'password-reset': {
        const { resetToken, resetUrl } = body;
        if (!resetToken || !resetUrl) {
          return NextResponse.json(
            { error: 'resetToken and resetUrl are required for password reset emails' },
            { status: 400 }
          );
        }
        const { sendPasswordResetEmail } = await import('@/services/email');
        result = await sendPasswordResetEmail(to, resetToken, resetUrl);
        break;
      }

      case 'notification': {
        const { title, message } = body;
        if (!title || !message) {
          return NextResponse.json(
            { error: 'title and message are required for notification emails' },
            { status: 400 }
          );
        }
        const { sendNotificationEmail } = await import('@/services/email');
        result = await sendNotificationEmail(to, title, message);
        break;
      }

      default:
        if (!html && !text) {
          return NextResponse.json(
            { error: 'Either html or text content is required' },
            { status: 400 }
          );
        }
        result = await sendEmail({ to, subject, html, text });
        break;
    }

    return NextResponse.json({
      success: true,
      message: 'Email sent successfully',
      id: result.id,
    });

  } catch (error) {
    console.error('Email API error:', error);
    return NextResponse.json(
      { 
        error: 'Failed to send email',
        details: error instanceof Error ? error.message : 'Unknown error'
      },
      { status: 500 }
    );
  }
}