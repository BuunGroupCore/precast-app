import cors from "cors";
import { config } from "dotenv";
import express, { Request, Response, json, urlencoded } from "express";
import helmet from "helmet";

{{#if (or (and plugins plugins.length) (and database (ne database 'none')))}}
import healthRoutes from "@/api/routes/health{{#if typescript}}.js{{/if}}";
{{/if}}
{{#if (includes plugins 'resend')}}
import emailRoutes from "@/api/routes/email{{#if typescript}}.js{{/if}}";
{{/if}}
{{#if authProvider}}
import authRoutes from "@/api/routes/auth{{#if typescript}}.js{{/if}}";
{{/if}}
import { 
  APP_CONFIG, 
  SERVER_CONFIG, 
  CORS_CONFIG, 
  HEALTH_CHECK_CONFIG 
} from "@/config/constants{{#if typescript}}.js{{/if}}";

config();

const app = express();

// Middleware
app.use(helmet());
app.use(cors(CORS_CONFIG));
app.use(json());
app.use(urlencoded({ extended: true }));

{{#if (or (and plugins plugins.length) (and database (ne database 'none')))}}
app.use("/api", healthRoutes);
{{/if}}
{{#if (includes plugins 'resend')}}
app.use("/api", emailRoutes);
{{/if}}
{{#if authProvider}}
app.use("/api/auth", authRoutes);
{{/if}}

app.get(HEALTH_CHECK_CONFIG.path, (req: Request, res: Response) => {
  res.json({ 
    status: "ok", 
    message: HEALTH_CHECK_CONFIG.message,
    timestamp: new Date().toISOString(),
    version: APP_CONFIG.version,
    environment: APP_CONFIG.environment
  });
});

app.get(`${SERVER_CONFIG.apiPrefix}/hello`, (req: Request, res: Response) => {
  res.json({ 
    message: `Hello from ${APP_CONFIG.name}!`,
    version: APP_CONFIG.version
  });
});

// 404 handler
app.use("*", (req: Request, res: Response) => {
  res.status(404).json({ 
    error: "Route not found",
    path: req.originalUrl
  });
});

// Error handler
app.use((err: Error, req: Request, res: Response) => {
  // Log error in development only
  if (process.env.NODE_ENV === "development") {
    // eslint-disable-next-line no-console
    console.error(err.stack);
  }
  res.status(500).json({ 
    error: "Internal server error",
    message: process.env.NODE_ENV === "development" ? err.message : "Something went wrong"
  });
});

{{#if (or (includes powerups "ngrok") (includes powerups "traefik") (includes powerups "cloudflare-tunnel"))}}
// Listen on all interfaces (0.0.0.0) to allow tunnel access
app.listen(SERVER_CONFIG.port, "0.0.0.0", () => {
  // eslint-disable-next-line no-console
  console.log(`🚀 Server running on http://${SERVER_CONFIG.host}:${SERVER_CONFIG.port}`);
  // eslint-disable-next-line no-console
  console.log(`📋 Health check: http://${SERVER_CONFIG.host}:${SERVER_CONFIG.port}${HEALTH_CHECK_CONFIG.path}`);
  // eslint-disable-next-line no-console
  console.log(`🌍 Environment: ${APP_CONFIG.environment}`);
  {{#if (includes powerups "ngrok")}}
  // eslint-disable-next-line no-console
  console.log(`🌐 ngrok tunnel access enabled on 0.0.0.0:${SERVER_CONFIG.port}`);
  {{/if}}
  {{#if (includes powerups "traefik")}}
  // eslint-disable-next-line no-console
  console.log(`🚦 Traefik proxy access enabled on 0.0.0.0:${SERVER_CONFIG.port}`);
  {{/if}}
  {{#if (includes powerups "cloudflare-tunnel")}}
  // eslint-disable-next-line no-console
  console.log(`☁️ Cloudflare tunnel access enabled on 0.0.0.0:${SERVER_CONFIG.port}`);
  {{/if}}
});
{{else}}
// Listen on localhost only
app.listen(SERVER_CONFIG.port, SERVER_CONFIG.host, () => {
  // eslint-disable-next-line no-console
  console.log(`🚀 Server running on http://${SERVER_CONFIG.host}:${SERVER_CONFIG.port}`);
  // eslint-disable-next-line no-console
  console.log(`📋 Health check: http://${SERVER_CONFIG.host}:${SERVER_CONFIG.port}${HEALTH_CHECK_CONFIG.path}`);
  // eslint-disable-next-line no-console
  console.log(`🌍 Environment: ${APP_CONFIG.environment}`);
});
{{/if}}